<!doctype html>
<html class="dark" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ZainFlix - Profile Selection</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="src/assets/styles/pages/profile.css" />
    <link rel="stylesheet" href="src/assets/styles/pages/profile-management.css" />
  </head>
  <body>
    <header>
      <div>
        <h2 class="logo">ZainFlix</h2>
      </div>
      <button class="logout-button" onclick="handleLogout()">Logout</button>
    </header>

    <div class="main-container">
      <div class="title-container">
        <h1 class="main-title">Who is watching?</h1>
      </div>

      <div class="profiles-grid">
        <div class="profile-item">
          <div class="profile-card" data-theme="magenta">
            <span class="material-symbols-outlined profile-icon">swords</span>
          </div>
          <span class="profile-name">Katana</span>
        </div>

        <div class="profile-item">
          <div class="profile-card" data-theme="purple">
            <span class="material-symbols-outlined profile-icon"
              >head_mounted_device</span
            >
          </div>
          <span class="profile-name">VR User</span>
        </div>

        <div class="profile-item">
          <div class="profile-card" data-theme="cyan">
            <span class="material-symbols-outlined profile-icon"
              >smart_toy</span
            >
          </div>
          <span class="profile-name">Robot</span>
        </div>

        <div class="profile-item">
          <div class="add-profile-card">
            <span class="material-symbols-outlined add-icon">add</span>
          </div>
          <span class="add-profile-name">Add Profile</span>
        </div>
      </div>

        <div class="manage-button-container">
          <button class="manage-button" id="manageProfilesBtn">Manage Profiles</button>
          <button class="done-button" id="doneManagingBtn" style="display: none;">Done</button>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-backdrop" id="editProfileModal">
      <div class="modal-outer">
        <div class="modal-content edit-profile-modal">
          <!-- Close Button -->
          <button class="close-btn" id="closeEditModal">
            <span class="material-symbols-outlined">close</span>
          </button>

          <!-- Modal Header -->
          <div class="edit-modal-header">
            <h2>Edit Profile</h2>
          </div>

          <!-- Profile Edit Form -->
          <div class="edit-form-container">
            <!-- Profile Icon -->
            <div class="profile-icon-selector">
              <div class="current-icon" id="currentIcon">
                <span class="material-symbols-outlined">swords</span>
              </div>
              <div class="icon-options" id="iconOptions">
                <div class="icon-option" data-icon="swords" data-color="#f000ff">
                  <span class="material-symbols-outlined">swords</span>
                </div>
                <div class="icon-option" data-icon="head_mounted_device" data-color="#8b5cf6">
                  <span class="material-symbols-outlined">head_mounted_device</span>
                </div>
                <div class="icon-option" data-icon="smart_toy" data-color="#00f0ff">
                  <span class="material-symbols-outlined">smart_toy</span>
                </div>
                <div class="icon-option" data-icon="rocket_launch" data-color="#22c55e">
                  <span class="material-symbols-outlined">rocket_launch</span>
                </div>
                <div class="icon-option" data-icon="auto_awesome" data-color="#f59e0b">
                  <span class="material-symbols-outlined">auto_awesome</span>
                </div>
                <div class="icon-option" data-icon="music_note" data-color="#ef4444">
                  <span class="material-symbols-outlined">music_note</span>
                </div>
                <div class="icon-option" data-icon="sports_esports" data-color="#3b82f6">
                  <span class="material-symbols-outlined">sports_esports</span>
                </div>
                <div class="icon-option" data-icon="movie" data-color="#ec4899">
                  <span class="material-symbols-outlined">movie</span>
                </div>
              </div>
            </div>

            <!-- Profile Name -->
            <div class="form-group">
              <label for="profileName">Profile Name</label>
              <input type="text" id="profileName" maxlength="20" placeholder="Enter profile name">
            </div>



            <!-- Action Buttons -->
            <div class="modal-actions">
              <button class="btn-cancel" id="cancelEditBtn">Cancel</button>
              <button class="btn-save" id="saveProfileBtn">Save Changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Simplified approach - remove all existing complexity
      let isManageMode = false;
      let editingProfile = null;

      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Initializing profile page');
        
        // Check session
        const userSession = localStorage.getItem("userSession");
        if (!userSession) {
          console.log("No user session found, redirecting to login");
          window.location.href = "login.html";
          return;
        }
        
        // Setup all event listeners
        setupProfileSelection();
        setupManageButton();
        setupLogoutButton();
        setupAddProfileButton();
        setupModalEvents();
        
        console.log('Profile page initialized successfully');
      });

      function setupProfileSelection() {
        document.querySelectorAll(".profile-card").forEach((card) => {
          card.addEventListener("click", function (e) {
            console.log('Profile card clicked, isManageMode:', isManageMode);
            
            if (!isManageMode) {
              const profileName = this.parentElement.querySelector(".profile-name").textContent;
              const profileData = {
                name: profileName,
                theme: this.dataset.theme,
                selectedTime: new Date().toISOString(),
              };

              console.log('Selecting profile:', profileName);
              
              try {
                localStorage.setItem("selectedProfile", JSON.stringify(profileData));
                window.location.href = "home.html";
              } catch (error) {
                console.error('Error selecting profile:', error);
                alert('Error selecting profile. Please try again.');
              }
            }
          });
        });
      }

      function setupManageButton() {
        const manageBtn = document.getElementById('manageProfilesBtn');
        const doneBtn = document.getElementById('doneManagingBtn');
        const profilesGrid = document.querySelector('.profiles-grid');
        
        if (!manageBtn) {
          console.error('Manage button not found');
          return;
        }

        manageBtn.addEventListener('click', function(e) {
          console.log('Manage Profiles clicked');
          e.preventDefault();
          enterManageMode();
        });

        if (doneBtn) {
          doneBtn.addEventListener('click', function(e) {
            console.log('Done button clicked');
            e.preventDefault();
            exitManageMode();
          });
        }

        function enterManageMode() {
          isManageMode = true;
          profilesGrid.classList.add('manage-mode');
          manageBtn.style.display = 'none';
          doneBtn.style.display = 'block';
          setupManageModeListeners();
        }

        function exitManageMode() {
          isManageMode = false;
          profilesGrid.classList.remove('manage-mode');
          manageBtn.style.display = 'block';
          doneBtn.style.display = 'none';
          cleanupManageMode();
        }
      }

      function setupManageModeListeners() {
        const profileCards = document.querySelectorAll('.profile-card');
        
        profileCards.forEach((card) => {
          const profileItem = card.parentElement;
          
          // Edit functionality
          card.addEventListener('click', function(e) {
            if (isManageMode) {
              e.preventDefault();
              e.stopPropagation();
              const profileName = profileItem.querySelector('.profile-name').textContent;
              openEditModal(profileName);
            }
          });

          // Create delete button
          const deleteBtn = document.createElement('div');
          deleteBtn.className = 'delete-profile-btn';
          deleteBtn.innerHTML = '<span class="material-symbols-outlined">close</span>';
          deleteBtn.style.cssText = `
            position: absolute;
            top: -8px;
            right: -8px;
            width: 36px;
            height: 36px;
            background: rgba(239, 68, 68, 0.95);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            z-index: 20;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.2);
          `;

          const deleteIcon = deleteBtn.querySelector('.material-symbols-outlined');
          deleteIcon.style.cssText = `
            font-size: 20px;
            color: white;
          `;

          deleteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const profileName = profileItem.querySelector('.profile-name').textContent;
            if (confirm(`Are you sure you want to delete the profile "${profileName}"?`)) {
              deleteProfile(profileName, profileItem);
            }
          });

          // Show/hide delete button on hover
          profileItem.addEventListener('mouseenter', () => {
            deleteBtn.style.opacity = '1';
            deleteBtn.style.transform = 'scale(1)';
          });

          profileItem.addEventListener('mouseleave', () => {
            deleteBtn.style.opacity = '0';
            deleteBtn.style.transform = 'scale(0.8)';
          });

          profileItem.appendChild(deleteBtn);
        });
      }

      function cleanupManageMode() {
        // Remove all delete buttons
        document.querySelectorAll('.delete-profile-btn').forEach(btn => btn.remove());
      }

      function setupLogoutButton() {
        const logoutBtn = document.querySelector('.logout-button');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function(e) {
            console.log('Logout button clicked');
            e.preventDefault();
            
            try {
              localStorage.removeItem("userSession");
              localStorage.removeItem("selectedProfile");
              localStorage.removeItem("rememberUser");
              
              if (window.AuthService) {
                window.AuthService.logout();
              }
              
              window.location.href = "index.html";
            } catch (error) {
              console.error('Error during logout:', error);
              window.location.href = "index.html";
            }
          });
        }
      }

      function setupAddProfileButton() {
        const addProfileBtn = document.querySelector('.add-profile-card');
        if (addProfileBtn) {
          addProfileBtn.addEventListener('click', function(e) {
            console.log('Add profile button clicked');
            e.preventDefault();
            
            const profileName = prompt("Enter profile name:");
            if (profileName) {
              const newProfile = {
                name: profileName,
                theme: "blue",
                createdTime: new Date().toISOString(),
              };

              localStorage.setItem("newProfile", JSON.stringify(newProfile));
              alert(`Profile "${profileName}" created!`);
            }
          });
        }
      }

      // Modal Functions
      function openEditModal(profileName) {
        console.log('Opening edit modal for:', profileName);
        editingProfile = profileName;
        
        const editModal = document.getElementById('editProfileModal');
        if (!editModal) {
          console.error('Edit modal not found');
          return;
        }

        // Populate modal
        document.getElementById('profileName').value = profileName;
        
        const profileData = getProfileData(profileName);
        if (profileData) {
          selectIcon(profileData.icon);
          updateCurrentIcon(profileData.icon, profileData.color);
        }
        
        editModal.classList.add('show');
      }

      function closeEditModal() {
        console.log('Closing edit modal');
        const editModal = document.getElementById('editProfileModal');
        if (editModal) {
          editModal.classList.remove('show');
        }
        editingProfile = null;
        resetModalForm();
      }

      function resetModalForm() {
        document.getElementById('profileName').value = '';
        clearIconSelection();
      }

      function setupModalEvents() {
        const closeEditModalBtn = document.getElementById('closeEditModal');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');

        if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditModal);
        if (cancelEditBtn) cancelEditBtn.addEventListener('click', closeEditModal);
        
        if (saveProfileBtn) {
          saveProfileBtn.addEventListener('click', saveProfileChanges);
        }

        // Close modal on backdrop click
        const editModal = document.getElementById('editProfileModal');
        if (editModal) {
          editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
              closeEditModal();
            }
          });
        }

        // Icon option selection
        document.querySelectorAll('.icon-option').forEach(option => {
          option.addEventListener('click', () => {
            selectIcon(option.dataset.icon);
            const currentProfileData = getProfileData(editingProfile);
            const profileColor = currentProfileData ? currentProfileData.color : '#f000ff';
            updateCurrentIcon(option.dataset.icon, profileColor);
          });
        });

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && editModal && editModal.classList.contains('show')) {
            closeEditModal();
          }
        });
      }

      function saveProfileChanges() {
        const newName = document.getElementById('profileName').value.trim();
        const selectedIcon = document.querySelector('.icon-option.selected');
        
        console.log('Saving changes:', { newName, selectedIcon });
        
        if (!newName) {
          alert('Please enter a profile name');
          return;
        }
        
        if (!selectedIcon) {
          alert('Please select an icon');
          return;
        }
        
        const currentProfileData = getProfileData(editingProfile);
        const profileColor = currentProfileData ? currentProfileData.color : '#f000ff';
        
        const profileData = {
          name: newName,
          icon: selectedIcon.dataset.icon,
          color: profileColor
        };
        
        // Update the UI
        updateProfileCard(editingProfile, profileData);
        
        // Save to localStorage for ProfileManager to use
        saveProfileToLocalStorage(editingProfile, newName, profileData);
        
        // Show success message
        showNotification(`Profile "${newName}" updated successfully`);
        closeEditModal();
        
        // Exit manage mode after successful edit
        setTimeout(() => {
          exitManageMode();
        }, 1000);
      }

      function updateProfileCard(oldName, newProfileData) {
        const profileItems = document.querySelectorAll('.profile-item');
        
        profileItems.forEach(item => {
          const profileNameElement = item.querySelector('.profile-name');
          if (profileNameElement && profileNameElement.textContent === oldName) {
            // Update name
            profileNameElement.textContent = newProfileData.name;
            
            // Update icon - try both selectors
            let iconElement = item.querySelector('.material-symbols-outlined.profile-icon');
            if (!iconElement) {
              iconElement = item.querySelector('.profile-icon');
            }
            
            if (iconElement) {
              console.log('Updating icon from:', iconElement.textContent, 'to:', newProfileData.icon);
              iconElement.textContent = newProfileData.icon;
              console.log('Icon updated successfully');
            } else {
              console.error('Icon element not found for profile:', oldName);
              // Try to find any material-symbols-outlined as fallback
              const anyIcon = item.querySelector('.material-symbols-outlined');
              if (anyIcon) {
                console.log('Found fallback icon element, updating:', anyIcon);
                anyIcon.textContent = newProfileData.icon;
              }
            }
            
            // Update theme color on the card if needed
            const profileCard = item.querySelector('.profile-card');
            if (profileCard && newProfileData.color) {
              profileCard.dataset.theme = newProfileData.color;
              console.log('Updated theme to:', newProfileData.color);
            }
            
            console.log('Profile card fully updated');
            return;
          }
        });
      }

      function deleteProfile(profileName, element) {
        element.style.transition = 'all 0.3s ease';
        element.style.transform = 'scale(0.8)';
        element.style.opacity = '0';
        
        setTimeout(() => {
          element.remove();
          
          // Also remove from localStorage
          deleteProfileFromStorage(profileName);
          
          showNotification(`Profile "${profileName}" deleted`);
        }, 300);
      }

      // Helper Functions
      function getProfileData(profileName) {
        // Check if it's an existing profile
        if (profileName === 'Katana') {
          return { icon: 'swords', color: '#f000ff' };
        }
        if (profileName === 'VR User') {
          return { icon: 'head_mounted_device', color: '#8b5cf6' };
        }
        if (profileName === 'Robot') {
          return { icon: 'smart_toy', color: '#00f0ff' };
        }
        
        // If it's a custom/new profile, use defaults
        console.log('Profile not found in defaults, using default values for:', profileName);
        return { icon: 'smart_toy', color: '#00f0ff' };
      }

      function selectIcon(iconName) {
        clearIconSelection();
        const iconOption = document.querySelector(`.icon-option[data-icon="${iconName}"]`);
        if (iconOption) {
          iconOption.classList.add('selected');
        }
      }

      function clearIconSelection() {
        document.querySelectorAll('.icon-option').forEach(option => {
          option.classList.remove('selected');
        });
      }

      function updateCurrentIcon(iconName, color) {
        const currentIcon = document.getElementById('currentIcon');
        if (currentIcon) {
          currentIcon.innerHTML = `<span class="material-symbols-outlined">${iconName}</span>`;
          currentIcon.style.background = color + '20';
          currentIcon.style.color = color;
        }
      }

      function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'profile-notification';
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add('show');
        }, 100);

        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }, 2000);
      }

      function saveProfileToLocalStorage(oldName, newName, profileData) {
        try {
          // Get current user session
          const userSession = localStorage.getItem("userSession");
          const userKey = userSession ? JSON.parse(userSession).email : 'default';
          
          // Get user-specific custom profiles
          const storageKey = `customProfiles_${userKey}`;
          let customProfiles = localStorage.getItem(storageKey);
          customProfiles = customProfiles ? JSON.parse(customProfiles) : {};
          
          // Update profile
          customProfiles[newName] = {
            ...profileData,
            avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(newName)}&background=${profileData.color.replace('#', '')}&color=fff&size=128`
          };
          
          // If name changed, remove old one
          if (oldName !== newName) {
            delete customProfiles[oldName];
            
            // Update selectedProfile if it was the old name
            const selectedProfile = localStorage.getItem('selectedProfile');
            if (selectedProfile) {
              const selected = JSON.parse(selectedProfile);
              if (selected.name === oldName) {
                selected.name = newName;
                localStorage.setItem('selectedProfile', JSON.stringify(selected));
              }
            }
          }
          
          // Save back to localStorage with user-specific key
          localStorage.setItem(storageKey, JSON.stringify(customProfiles));
          console.log('Profile saved to localStorage for user:', userKey, newName, profileData);
          console.log('All custom profiles for user:', customProfiles);
        } catch (error) {
          console.error('Error saving profile to localStorage:', error);
        }
      }
            }
          }
          
          // Save back to localStorage
          localStorage.setItem('customProfiles', JSON.stringify(customProfiles));
          console.log('Profile saved to localStorage:', newName, profileData);
          console.log('All custom profiles:', customProfiles);
        } catch (error) {
          console.error('Error saving profile to localStorage:', error);
        }
      }

      function deleteProfileFromStorage(profileName) {
        try {
          // Get current user session
          const userSession = localStorage.getItem("userSession");
          const userKey = userSession ? JSON.parse(userSession).email : 'default';
          
          // Remove from user-specific custom profiles
          const storageKey = `customProfiles_${userKey}`;
          let customProfiles = localStorage.getItem(storageKey);
          customProfiles = customProfiles ? JSON.parse(customProfiles) : {};
          
          if (customProfiles[profileName]) {
            delete customProfiles[profileName];
            localStorage.setItem(storageKey, JSON.stringify(customProfiles));
            console.log('Profile removed from storage for user:', userKey, profileName);
          }
          
          // Check if it's a default profile that was customized
          // We need to mark it as deleted in a user-specific deleted profiles list
          const deletedKey = `deletedProfiles_${userKey}`;
          let deletedProfiles = localStorage.getItem(deletedKey);
          deletedProfiles = deletedProfiles ? JSON.parse(deletedProfiles) : [];
          
          if (!deletedProfiles.includes(profileName)) {
            deletedProfiles.push(profileName);
            localStorage.setItem(deletedKey, JSON.stringify(deletedProfiles));
            console.log('Profile added to deleted list for user:', userKey, profileName);
          }
          
        } catch (error) {
          console.error('Error deleting profile from storage:', error);
        }
      }

      // Load and display custom profiles on page load
      function loadCustomProfiles() {
        try {
          // Get current user session
          const userSession = localStorage.getItem("userSession");
          const userKey = userSession ? JSON.parse(userSession).email : 'default';
          
          const storageKey = `customProfiles_${userKey}`;
          const customProfiles = localStorage.getItem(storageKey);
          if (customProfiles) {
            const profiles = JSON.parse(customProfiles);
            console.log('Loading custom profiles for user:', userKey, profiles);
            
            // Update UI to show custom profiles
            Object.entries(profiles).forEach(([name, data]) => {
              updateProfileCard(name, data);
            });
          }
          
          // Also load deleted profiles to hide default ones
          const deletedKey = `deletedProfiles_${userKey}`;
          const deletedProfiles = localStorage.getItem(deletedKey);
          if (deletedProfiles) {
            const deleted = JSON.parse(deletedProfiles);
            console.log('Deleted profiles for user:', userKey, deleted);
            
            // Hide deleted default profiles
            deleted.forEach(deletedName => {
              const profileItems = document.querySelectorAll('.profile-item');
              profileItems.forEach(item => {
                const profileNameElement = item.querySelector('.profile-name');
                if (profileNameElement && profileNameElement.textContent === deletedName) {
                  item.style.display = 'none';
                }
              });
            });
          }
        } catch (error) {
          console.error('Error loading custom profiles:', error);
        }
      }

      // Initialize custom profiles when page loads
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          loadCustomProfiles();
        }, 100);
      });
    </script>
    <script src="src/assets/scripts/services/auth.service.js"></script>
  </body>
</html>
